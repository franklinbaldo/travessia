---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

const riobaldoJournals = await getCollection('bastidores-riobaldo');
const tedJournals = await getCollection('bastidores-ted');

function getExcerpt(body: string | undefined, len = 140): string {
  const plain = body?.replace(/^#+\s+.*/gm, '').replace(/[*_~`\[\]()]/g, '').replace(/\n+/g, ' ').trim() || '';
  if (plain.length <= len) return plain;
  return plain.slice(0, len).replace(/\s+\S*$/, '') + '…';
}

const sortedRiobaldo = riobaldoJournals
  .sort((a, b) => a.id.localeCompare(b.id, undefined, { numeric: true }))
  .map(entry => ({
    id: entry.id,
    label: entry.id.replace(/-/g, ' ').replace(/_/g, ' — '),
    excerpt: getExcerpt(entry.body),
  }));

const sortedTed = tedJournals
  .sort((a, b) => a.id.localeCompare(b.id, undefined, { numeric: true }))
  .map(entry => ({
    id: entry.id,
    label: entry.id.replace(/-/g, ' ').replace(/_/g, ' — '),
    excerpt: getExcerpt(entry.body),
  }));

const base = import.meta.env.BASE_URL;
---

<Layout title="Bastidores | Travessia" isBastidores={true}>
  <header class="bastidores-header">
    <h1>Bastidores</h1>
    <p>Journals de sessão dos agentes autônomos — o processo por dentro.</p>
  </header>

  <section class="bastidores-section">
    <h2 class="bastidores-section-title bastidores-title-rio">Riobaldo</h2>
    {sortedRiobaldo.length === 0
      ? <p class="bastidores-empty">Nenhum registro de Riobaldo ainda.</p>
      : (
        <div class="bastidores-grid">
          {sortedRiobaldo.map((entry) => (
            <a href={`${base}bastidores/riobaldo/${entry.id}`} class="bastidores-card bastidores-card-rio">
              <span class="bastidores-card-id">{entry.label}</span>
              {entry.excerpt && <p class="bastidores-card-excerpt">{entry.excerpt}</p>}
            </a>
          ))}
        </div>
      )
    }
  </section>

  <section class="bastidores-section">
    <h2 class="bastidores-section-title bastidores-title-ted">Ted Chiang</h2>
    {sortedTed.length === 0
      ? <p class="bastidores-empty">Nenhum registro de Ted ainda.</p>
      : (
        <div class="bastidores-grid">
          {sortedTed.map((entry) => (
            <a href={`${base}bastidores/ted/${entry.id}`} class="bastidores-card bastidores-card-ted">
              <span class="bastidores-card-id">{entry.label}</span>
              {entry.excerpt && <p class="bastidores-card-excerpt">{entry.excerpt}</p>}
            </a>
          ))}
        </div>
      )
    }
  </section>
</Layout>
