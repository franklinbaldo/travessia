---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';

const base = import.meta.env.BASE_URL;

const allDialogo = await getCollection('dialogo');
const allManuscrito = await getCollection('manuscrito');

function stripMarkdown(md: string | undefined): string {
  return md?.replace(/^#+\s+/gm, '').replace(/[*_~`\[\]()]/g, '').replace(/\n+/g, ' ').trim() || '';
}

function getExcerpt(body: string | undefined, len = 180): string {
  const plain = stripMarkdown(body);
  if (plain.length <= len) return plain;
  return plain.slice(0, len).replace(/\s+\S*$/, '') + '…';
}

interface BlogPost {
  slug: string;
  titulo: string;
  tipo: string;
  subtitulo?: string;
  autor?: string;
  autorClasse?: string;
  excerpt: string;
  url: string;
  ordem: number;
}

const posts: BlogPost[] = [];

for (const entry of allDialogo) {
  const isRio = entry.id.includes('rio');
  const num = parseInt(entry.id.match(/^(\d+)/)?.[1] || '0');
  const autor = isRio ? 'Riobaldo' : 'Ted Chiang';

  posts.push({
    slug: entry.id,
    titulo: `Carta ${num} — ${autor}`,
    tipo: 'carta',
    autor,
    autorClasse: isRio ? 'rio' : 'ted',
    excerpt: getExcerpt(entry.body),
    url: `${base}carta/${entry.id}`,
    ordem: num,
  });
}

for (const entry of allManuscrito) {
  posts.push({
    slug: entry.id,
    titulo: entry.data.titulo,
    tipo: entry.data.tipo,
    subtitulo: entry.data.subtitulo,
    excerpt: getExcerpt(entry.body),
    url: `${base}texto/${entry.id}`,
    ordem: 100 + (entry.data.ordem || 999),
  });
}

posts.sort((a, b) => a.ordem - b.ordem);

const tiposSet = new Set(posts.map(p => p.tipo));
const tipos = ['todos', ...Array.from(tiposSet)];

const tipoLabels: Record<string, string> = {
  todos: 'Tudo',
  carta: 'Cartas',
  abertura: 'Abertura',
  causo: 'Causos',
  fechamento: 'Fechamento',
  fragmento: 'Fragmentos',
};
---

<Layout title="Travessia" isHome={true}>

  <!-- Hero Section — A Nascente -->
  <section class="blog-hero">
    <div class="hero-image-wrap">
      <img
        src={`${base}farmhouse_table.png`}
        alt="Mesa de fazenda — a nascente da travessia"
        decoding="async"
        loading="eager"
      />
    </div>
    <h1>Travessia</h1>
    <p class="hero-quote">"O diabo não há! É o homem humano. Travessia."</p>
    <p class="hero-sub">Diálogo epistolar entre Ted Chiang e Riobaldo Tatarana</p>
  </section>

  <!-- Veredas — Category Navigation -->
  {tipos.length > 2 && (
    <nav class="veredas" aria-label="Categorias">
      {tipos.map((tipo) => (
        <button
          class={`vereda ${tipo === 'todos' ? 'active' : ''}`}
          data-filter={tipo}
        >
          {tipoLabels[tipo] || tipo}
        </button>
      ))}
    </nav>
  )}

  <!-- Blog Feed — O Fluxo Contínuo -->
  {posts.length === 0 ? (
    <p class="silencio">O sertão ainda está em silêncio.</p>
  ) : (
    <div class="blog-feed">
      {posts.map((post) => (
        <a href={post.url} class="blog-card" data-tipo={post.tipo}>
          <span class={`card-tipo tipo-${post.tipo}`}>
            {tipoLabels[post.tipo] || post.tipo}
          </span>
          <h2 class="card-titulo">{post.titulo}</h2>
          {post.subtitulo && <p class="card-subtitulo">{post.subtitulo}</p>}
          <p class="card-excerpt">{post.excerpt}</p>
        </a>
      ))}
    </div>
  )}

  <!-- Category filter script -->
  <script is:inline>
    (function() {
      var buttons = document.querySelectorAll('.vereda');
      if (!buttons.length) return;

      buttons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          var filter = this.getAttribute('data-filter');

          buttons.forEach(function(b) { b.classList.remove('active'); });
          this.classList.add('active');

          document.querySelectorAll('.blog-card').forEach(function(card) {
            if (filter === 'todos' || card.getAttribute('data-tipo') === filter) {
              card.style.display = '';
            } else {
              card.style.display = 'none';
            }
          });
        });
      });
    })();
  </script>

</Layout>
