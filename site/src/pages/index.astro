---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';

const base = import.meta.env.BASE_URL;

const allDialogo = await getCollection('dialogo');
const allManuscrito = await getCollection('manuscrito');

function stripMarkdown(md: string | undefined): string {
  return md?.replace(/^#+\s+/gm, '').replace(/[*_~`\[\]()]/g, '').replace(/\n+/g, ' ').trim() || '';
}

function getExcerpt(body: string | undefined, len = 180): string {
  const plain = stripMarkdown(body);
  if (plain.length <= len) return plain;
  return plain.slice(0, len).replace(/\s+\S*$/, '') + '…';
}

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('pt-BR', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
    timeZone: 'UTC',
  }).format(date);
}

interface BlogPost {
  slug: string;
  titulo: string;
  tipo: string;
  subtitulo?: string;
  autor?: string;
  autorClasse?: string;
  excerpt: string;
  longExcerpt?: string;
  url: string;
  data?: Date;
  ordem: number;
}

const posts: BlogPost[] = [];

for (const entry of allDialogo) {
  const isRio = entry.data.autor.includes('Riobaldo');

  posts.push({
    slug: entry.id,
    titulo: entry.data.titulo,
    tipo: 'carta',
    autor: entry.data.autor,
    autorClasse: isRio ? 'rio' : 'ted',
    excerpt: getExcerpt(entry.body),
    longExcerpt: getExcerpt(entry.body, 320),
    url: `${base}carta/${entry.id}`,
    data: entry.data.data ? new Date(entry.data.data) : new Date(),
    ordem: entry.data.data ? new Date(entry.data.data).getTime() : Date.now(),
  });
}

for (const entry of allManuscrito) {
  posts.push({
    slug: entry.id,
    titulo: entry.data.titulo,
    tipo: entry.data.tipo,
    subtitulo: entry.data.subtitulo,
    excerpt: getExcerpt(entry.body),
    url: `${base}texto/${entry.id}`,
    ordem: entry.data.ordem || 999,
  });
}

// Reverse chronological — newest first (blog convention)
posts.sort((a, b) => b.ordem - a.ordem);

// Featured post: most recent carta
const featuredPost = posts.find(p => p.tipo === 'carta');
const gridPosts = posts.filter(p => p !== featuredPost);

const tiposSet = new Set(gridPosts.map(p => p.tipo));
const tipos = ['todos', ...Array.from(tiposSet)];

const tipoLabels: Record<string, string> = {
  todos: 'Tudo',
  carta: 'Cartas',
  abertura: 'Abertura',
  causo: 'Causos',
  fechamento: 'Fechamento',
  fragmento: 'Fragmentos',
};
---

<Layout title="Travessia" isHome={true}>

  <!-- Hero Section — Split Layout -->
  <section class="blog-hero">
    <div class="hero-split">
      <div class="hero-image-col">
        <img
          src={`${base}farmhouse_table.png`}
          alt="Mesa de fazenda — a nascente da travessia"
          decoding="async"
          loading="eager"
        />
      </div>
      <div class="hero-text-col">
        <h1>Travessia</h1>
        <p class="hero-quote">"O diabo não há! É o homem humano. Travessia."</p>
        <p class="hero-sub">Dois homens que nunca se encontraram trocam cartas sobre o que não tem nome.</p>
        <div class="hero-characters">
          <span class="character-badge badge-riobaldo">Riobaldo Tatarana</span>
          <span class="character-badge badge-ted">Ted Chiang</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Featured Post — Última Carta -->
  {featuredPost && (
    <a href={featuredPost.url} class={`featured-post autor-border-${featuredPost.autorClasse}`} data-autor={featuredPost.autorClasse}>
      <div class="featured-label">Última Carta</div>
      <h2 class="card-titulo">{featuredPost.titulo}</h2>
      <p class="card-excerpt">{featuredPost.longExcerpt || featuredPost.excerpt}</p>
      <div class="card-meta">
        {featuredPost.autor && (
          <span class={`card-autor autor-${featuredPost.autorClasse}`}>{featuredPost.autor}</span>
        )}
        {featuredPost.data && (
          <time datetime={featuredPost.data.toISOString()}>
            {formatDate(featuredPost.data)}
          </time>
        )}
      </div>
    </a>
  )}

  <!-- Veredas — Category Navigation -->
  {tipos.length > 2 && (
    <nav class="veredas" aria-label="Categorias">
      {tipos.map((tipo) => (
        <button
          class={`vereda ${tipo === 'todos' ? 'active' : ''}`}
          data-filter={tipo}
        >
          {tipoLabels[tipo] || tipo}
        </button>
      ))}
    </nav>
  )}

  <!-- Blog Feed — O Fluxo Contínuo -->
  {gridPosts.length === 0 ? (
    <p class="silencio">O sertão ainda está em silêncio.</p>
  ) : (
    <div class="blog-feed">
      {gridPosts.map((post) => (
        <a href={post.url} class="blog-card" data-tipo={post.tipo} data-autor={post.autorClasse}>
          <span class={`card-tipo tipo-${post.tipo}`}>
            {tipoLabels[post.tipo] || post.tipo}
          </span>
          <h2 class="card-titulo">{post.titulo}</h2>
          {post.subtitulo && <p class="card-subtitulo">{post.subtitulo}</p>}
          <p class="card-excerpt">{post.excerpt}</p>
          <div class="card-meta">
            {post.autor && (
              <span class={`card-autor autor-${post.autorClasse}`}>{post.autor}</span>
            )}
            {post.data && (
              <time datetime={post.data.toISOString()}>
                {formatDate(post.data)}
              </time>
            )}
          </div>
        </a>
      ))}
    </div>
  )}

  <!-- Category filter script -->
  <script is:inline>
    (function() {
      var buttons = document.querySelectorAll('.vereda');
      if (!buttons.length) return;

      buttons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          var filter = this.getAttribute('data-filter');

          buttons.forEach(function(b) { b.classList.remove('active'); });
          this.classList.add('active');

          document.querySelectorAll('.blog-card').forEach(function(card) {
            if (filter === 'todos' || card.getAttribute('data-tipo') === filter) {
              card.style.display = '';
            } else {
              card.style.display = 'none';
            }
          });
        });
      });
    })();
  </script>

</Layout>
