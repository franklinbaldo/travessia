---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import FooterNav from '../../components/FooterNav.astro';

export async function getStaticPaths() {
  const all = await getCollection('manuscrito');
  const sorted = all
    .filter(e => e.data.ordem !== undefined)
    .sort((a, b) => (a.data.ordem || 0) - (b.data.ordem || 0));

  return all.map(entry => {
    const currentIndex = sorted.findIndex(e => e.id === entry.id);
    const prev = currentIndex > 0 ? sorted[currentIndex - 1] : null;
    const next = currentIndex !== -1 && currentIndex < sorted.length - 1 ? sorted[currentIndex + 1] : null;

    return {
      params: { slug: entry.id },
      props: { entry, prev, next },
    };
  });
}

const base = import.meta.env.BASE_URL;
const { entry, prev, next } = Astro.props;
const { Content } = await render(entry);
---

<Layout title={entry.data.titulo}>
  <article>
    <header class="manuscrito-header">
      <h1>{entry.data.titulo}</h1>
      {entry.data.subtitulo && <h2>{entry.data.subtitulo}</h2>}
      {entry.data.epigrafe && (
        <blockquote class="manuscrito-epigrafe">
          <p>"{entry.data.epigrafe}"</p>
        </blockquote>
      )}
      <div class="separator"></div>
    </header>

    <div class="manuscrito-body">
      <Content />
    </div>
  </article>

  <FooterNav
    prev={prev ? { url: `${base}texto/${prev.id}`, title: prev.data.titulo } : undefined}
    next={next ? { url: `${base}texto/${next.id}`, title: next.data.titulo } : undefined}
  />
</Layout>
