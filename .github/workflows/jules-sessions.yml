name: Jules Sessions — Travessia

on:
  schedule:
    # ~100 sessoes por dia: a cada 15 minutos = 96 sessoes/dia
    # Cada sessao tem 10 steps alternando Ted e Riobaldo
    - cron: "*/15 * * * *"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  create-session:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determinar estado do dialogo e proximo turno
        id: meta
        run: |
          # Contar arquivos existentes em dialogo/ para determinar o proximo numero
          LAST_NUM=$(ls -1 dialogo/*.md 2>/dev/null | grep -v '.gitkeep' | sed 's/.*\///' | sed 's/-.*//' | sort -n | tail -1)
          if [ -z "$LAST_NUM" ]; then
            NEXT_NUM="01"
          else
            NEXT_NUM=$(printf "%02d" $((10#$LAST_NUM + 1)))
          fi

          # Calcular o range de turnos que esta sessao vai produzir (10 turnos)
          END_NUM=$(printf "%02d" $((10#$NEXT_NUM + 9)))

          # Titulo unico da sessao
          TITLE="Travessia Sessao — turnos #${NEXT_NUM} a #${END_NUM} (10 steps Ted/Riobaldo)"
          echo "next_turn=$NEXT_NUM" >> "$GITHUB_OUTPUT"
          echo "end_turn=$END_NUM" >> "$GITHUB_OUTPUT"
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "Titulo da sessao: $TITLE"
          echo "Turnos: $NEXT_NUM a $END_NUM"

      - name: Ler prompt combinado
        id: prompt
        run: |
          PROMPT_FILE=".jules/PROMPT-combined.md"

          if [ ! -f "$PROMPT_FILE" ]; then
            echo "::error::Arquivo $PROMPT_FILE nao encontrado!"
            exit 1
          fi

          echo "Lendo prompt combinado de: $PROMPT_FILE"

          # Usar delimitador heredoc para output multiline
          {
            echo "content<<PROMPT_EOF"
            cat "$PROMPT_FILE"
            echo ""
            echo "PROMPT_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Criar sessao Jules com 10 steps
        env:
          PROMPT_CONTENT: ${{ steps.prompt.outputs.content }}
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          REPO: ${{ github.repository }}
          SESSION_TITLE: ${{ steps.meta.outputs.title }}
        run: |
          jq -n \
            --arg prompt "$PROMPT_CONTENT" \
            --arg source "sources/github/$REPO" \
            --arg title "$SESSION_TITLE" \
            '{
              prompt: $prompt,
              sourceContext: {
                source: $source,
                githubRepoContext: {
                  startingBranch: "main"
                }
              },
              automationMode: "AUTO_CREATE_PR",
              title: $title
            }' > /tmp/payload.json

          echo "Criando sessao Jules: $SESSION_TITLE"

          curl 'https://jules.googleapis.com/v1alpha/sessions' \
            -X POST \
            --fail-with-body \
            -H "Content-Type: application/json" \
            -H "x-goog-api-key: $JULES_API_KEY" \
            -d @/tmp/payload.json
