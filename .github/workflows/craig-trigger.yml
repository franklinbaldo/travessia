name: Design Agents — Trigger

on:
  push:
    branches:
      - main
    paths:
      - ".jules/riobaldo/**"
      - ".jules/ted/**"
  workflow_dispatch:
    inputs:
      force:
        description: "Force all design agents regardless of count"
        default: "false"
        type: boolean

permissions:
  contents: read

# ─── Configuration ────────────────────────────────────────────────────────────
#
# CONTENT_AGENTS: space-separated list of agents whose sessions are counted.
#   To add a new content agent, append its name here and add a push path above.
#
# DESIGN_AGENTS: one entry per line, format "agent:ratio".
#   ratio = trigger every N content sessions.
#   To add a new design agent, append a line here and create .jules/<agent>/PROMPT.md.
#
# ──────────────────────────────────────────────────────────────────────────────
env:
  CONTENT_AGENTS: "riobaldo ted"
  DESIGN_AGENTS: |
    craig:4

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Count total content sessions
        id: count
        run: |
          # Count unique session numbers (numeric prefix of filenames) across
          # all content agent directories. Subdirs (cartas, fitas, etc.) are
          # included so high-numbered sessions are not missed.
          MAX_SESSION=0
          for agent in $CONTENT_AGENTS; do
            DIR=".jules/$agent"
            if [ ! -d "$DIR" ]; then continue; fi

            NUMS=$(find "$DIR" -name "*.md" ! -name ".gitkeep" \
              | xargs -I{} basename {} \
              | grep -oP '^\d+' \
              | sort -nu)

            for num in $NUMS; do
              n=$((10#$num))
              [ $n -gt $MAX_SESSION ] && MAX_SESSION=$n
            done
          done

          echo "total=$MAX_SESSION" >> "$GITHUB_OUTPUT"
          echo "Total content sessions counted: $MAX_SESSION"

      - name: Trigger design agents
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          REPO: ${{ github.repository }}
          TOTAL: ${{ steps.count.outputs.total }}
          FORCE: ${{ github.event.inputs.force }}
        run: |
          while IFS=':' read -r agent ratio; do
            # Skip blank lines (YAML multiline heredoc artifact)
            [ -z "$agent" ] && continue

            echo "── $agent (every $ratio sessions) ─────────────────"

            SHOULD_RUN=false

            if [ "$FORCE" = "true" ]; then
              SHOULD_RUN=true
              echo "  Forced via workflow_dispatch."
            elif [ "$TOTAL" -gt 0 ] && [ $(( TOTAL % ratio )) -eq 0 ]; then
              SHOULD_RUN=true
              echo "  Count $TOTAL is a multiple of $ratio. Triggering."
            else
              REMAINING=$(( ratio - (TOTAL % ratio) ))
              echo "  Count $TOTAL. Next trigger in $REMAINING session(s). Skipping."
            fi

            if [ "$SHOULD_RUN" = "true" ]; then
              PROMPT_FILE=".jules/$agent/PROMPT.md"
              if [ ! -f "$PROMPT_FILE" ]; then
                echo "  ERROR: $PROMPT_FILE not found. Skipping $agent."
                continue
              fi

              SESSION_NUM=$(printf "%03d" $(( TOTAL / ratio )))
              TITLE="Travessia — ${agent} #${SESSION_NUM}"

              jq -n \
                --rawfile prompt "$PROMPT_FILE" \
                --arg source "sources/github/$REPO" \
                --arg title "$TITLE" \
                '{
                  prompt: $prompt,
                  sourceContext: {
                    source: $source,
                    githubRepoContext: { startingBranch: "main" }
                  },
                  automationMode: "AUTO_CREATE_PR",
                  title: $title
                }' > /tmp/payload-${agent}.json

              curl 'https://jules.googleapis.com/v1alpha/sessions' \
                -X POST \
                --fail-with-body \
                -H "Content-Type: application/json" \
                -H "x-goog-api-key: $JULES_API_KEY" \
                -d @/tmp/payload-${agent}.json

              echo "  Session created for $agent (#${SESSION_NUM})."
            fi
          done <<< "$DESIGN_AGENTS"
